#!/usr/bin/env bash
set -euo pipefail

PASSED=false
trap '
    e=$?; $PASSED || {
        echo 1>&2 -e "━━━━━━━━━━━━FAILED (exitcode=$e}"
        exit $e
}' 0

PROJDIR=$(cd $(dirname "$0") && pwd -P)

cd "$PROJDIR"
[[ ${#@} -gt 0 && $1 == -C ]] && { shift; rm -rf .build; }

. ./pactivate
PATH="$PROJDIR/bin:$PATH"
cd "$PROJDIR"

#   Since we're testing tscript, we don't want to use it. So we manually
#   run through all the tests instead, similar how tscript would do it in
#   certain modes. Note that tscript parameters are not used here; instead
#   we just pass in whatever came from the command line.
for ts in tscript/*; do
    [[ -f "$ts" && -x "$ts" ]] || continue
    echo "━━━━━━━━━━━━ $ts"
    "$ts" "$@"
done

PASSED=true
