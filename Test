#!/usr/bin/env bash
set -euo pipefail

PASSED=false
trap '
    e=$?
    $PASSED && msg="════════════ PASSED" \
            || msg="════════════ FAILED (exitcode=$e)"
    echo 1>&2 "$msg"
    exit $e
}' 0

PROJDIR=$(cd $(dirname "$0") && pwd -P)

cd "$PROJDIR"
[[ ${#@} -gt 0 && $1 == -C ]] && { shift; rm -rf .build; }

. ./pactivate -q
cd "$PROJDIR"

mypy
pytest "$@"

#   Since we're testing tscript, we don't want to use it. So we manually
#   run through all the tests under comci-tests/ instead. Nor are tscript
#   used here; instead we just pass in whatever came from the command line.
for t in comci-tests/*; do
    [[ -f "$t" && -x "$t" ]] || continue      # `test` follows symlinks
    echo "════════════ $t"
    "$t" "$@"
done

PASSED=true
