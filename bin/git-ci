#!/usr/bin/env bash

SUBDIRECTORY_OK=1
. $(git --exec-path)/git-sh-setup

get_base_dir() {
    link_dir="$(dirname "${BASH_SOURCE[0]}")"
    link_target="$link_dir/$(readlink "${BASH_SOURCE[0]}")"
    (cd "$(dirname "$link_target")/.." && pwd)
}
base="$(get_base_dir)"

log() {
    parsed_revs=$(git rev-parse --default HEAD "$@") || exit

    commit="%C(auto)%h"
    format_good="$commit %Cgreen✓%Creset%C(auto)%d %s"
    format_bad="$commit %C(reverse red)✗%Creset%C(auto)%d %s"
    format_unknown="$commit%Creset %C(auto)?%d %s"

    while read -r rev; do
        test_status=$(git notes --ref=refs/notes/tests/default  show "$rev^{tree}" 2>/dev/null)
        [ $? = 0 ] || test_status=unknown

        format=
        case "$test_status" in
            good)    format="$format_good" ;;
            bad)     format="$format_bad" ;;
            unknown) format="$format_unknown" ;;
        esac

        git --no-pager log --format="$format" -1 $rev
    done < <(git rev-list $parsed_revs) \
        | git_pager
}

action="$1"; shift
case "$action" in
    log) log "$@"                                           ;;
      *) exec "$base/git-test/bin/git-test" "$action" "$@"  ;;
esac

